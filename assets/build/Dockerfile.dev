# ---------------------------------------------
# STAGE 1: Build the full virtual environment
# ---------------------------------------------
    FROM python:3.13-alpine AS build

    # Set working directory
    WORKDIR /app
    
    # Install build dependencies
    RUN apk add --no-cache \
        gcc \
        musl-dev \
        python3-dev \
        libffi-dev \
        openssl-dev \
        build-base \
        bash \
        curl \
        git \
        which
    
    # Copy requirements files
    COPY /assets/build/requirements.prod.txt .
    COPY /assets/build/requirements.dev.txt .
    
    # Create virtual environment and install packages
    RUN python -m venv /opt/venv && \
        /opt/venv/bin/pip install --upgrade pip && \
        /opt/venv/bin/pip install --no-cache-dir -r requirements.prod.txt && \
        /opt/venv/bin/pip install --no-cache-dir -r requirements.dev.txt
    
    # ---------------------------------------------
    # STAGE 2: Final development image
    # ---------------------------------------------
    FROM python:3.13-alpine
    
    # Set working directory
    WORKDIR /app
    
    # Install runtime dependencies
    RUN apk add --no-cache \
        bash \
        curl \
        git \
        which \
        libffi \
        openssl
    
    # Copy virtual environment
    COPY --from=build /opt/venv /opt/venv
    
    # Set environment variables
    ENV PYTHONUNBUFFERED=1 \
        PYTHONDONTWRITEBYTECODE=1 \
        PATH="/opt/venv/bin:$PATH" \
        GOOGLE_CLOUD_CREDENTIALS="/app/assets/secrets/gcp_credentials.json"
    
    # Default command
    CMD [ "python" ]
    